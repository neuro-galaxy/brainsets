name: Publish to PyPI

on:
  push:
    tags:
      - "v*"

jobs:
  validate-tag:
    name: Validate tag follows PEP 440
    runs-on: ubuntu-latest
    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Validate tag is PEP 440 compliant
        run: |
          TAG="${{ github.ref_name }}"
          
          # Validate against PEP 440 canonical format using the exact regex from PEP 440
          python << EOF
          import re
          import sys
          from packaging.version import Version, InvalidVersion
          
          tag = '$TAG'
          version = tag.removeprefix("v")
          
          # Exact regex from PEP 440 for canonical version format
          # Pattern from: https://peps.python.org/pep-0440/#appendix-b-parsing-version-strings-with-regular-expressions
          def is_canonical(version):
              return re.match(r'^([1-9][0-9]*!)?(0|[1-9][0-9]*)(\.(0|[1-9][0-9]*))*((a|b|rc)(0|[1-9][0-9]*))?(\.post(0|[1-9][0-9]*))?(\.dev(0|[1-9][0-9]*))?$', version) is not None
          
          if not is_canonical(version):
              print(f'âœ— Tag {tag} (version {version}) is not in PEP 440 canonical format')
              sys.exit(1)
          
          # Also validate with packaging to ensure it's a valid PEP 440 version
          try:
              v = Version(version)
              print(f'âœ“ Tag {tag} is valid PEP 440 canonical version: {v}')
          except InvalidVersion as e:
              print(f'âœ— Tag {tag} (version {version}) is not a valid PEP 440 version: {e}')
              sys.exit(1)
          EOF

  build:
    name: Build distribution ðŸ“¦
    needs: validate-tag
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0 # IMPORTANT: Required for setuptools-scm to see tags!
        persist-credentials: false

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        enable-cache: true

    - name: Build a binary wheel and a source tarball
      run: uv build

    - name: Store the distribution packages
      uses: actions/upload-artifact@v4
      with:
        name: python-package-distributions
        path: dist/

  publish-to-pypi:
    name: Publish Python ðŸ distribution ðŸ“¦ to PyPI
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: pypi
      url: https://pypi.org/p/brainsets
    permissions:
      id-token: write # IMPORTANT: mandatory for trusted publishing

    steps:
      - name: Download all the dists
        uses: actions/download-artifact@v4
        with:
          name: python-package-distributions
          path: dist/

      - name: Publish distribution ðŸ“¦ to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1

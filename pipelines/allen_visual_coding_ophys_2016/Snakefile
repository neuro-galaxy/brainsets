######################################################
# Allen Brain Observatory - Visual Coding OPhys (2016)
######################################################

DATASET = "allen_visual_coding_ophys_2016"

RAW_DIR = config["RAW_DIR"]
PROCESSED_DIR = config["PROCESSED_DIR"]

with open(f"pipelines/{DATASET}/session_ids.txt",) as fh:
    session_ids = [line.strip() for line in fh]

rule download_data:
    output:
        f"{RAW_DIR}/{DATASET}/ophys_experiment_data/{{session_id}}.nwb"
    shell:
        f"""
        mkdir -p {RAW_DIR}/{DATASET}
        python pipelines/allen_visual_coding_ophys_2016/download_data.py --output_dir {RAW_DIR}/{DATASET} --session_id {{wildcards.session_id}}
        """

rule prepare_data:
    input:
        py_script = f"pipelines/{DATASET}/prepare_data.py",
        nwb_file = f"{RAW_DIR}/{DATASET}/ophys_experiment_data/{{session_id}}.nwb"
    output:
        h5file = f"{PROCESSED_DIR}/{DATASET}/ophys_experiment_data/{{session_id}}.h5",
    log:
        f".snakemake/logs/{DATASET}/prepare_data.{{session_id}}.log"
    shell:
        f"""
        mkdir -p {PROCESSED_DIR}/{DATASET}/tmp
        python {{input.py_script}} --input_file {{input.nwb_file}} --output_dir {PROCESSED_DIR}/{DATASET} >> {{log}}
        find {PROCESSED_DIR}/{DATASET}/ -type f -name "*.h5" | sed "s|^{PROCESSED_DIR}/{DATASET}//||" > {{output}}
        """

rule all:
    input:
        expand(f"{PROCESSED_DIR}/{DATASET}/ophys_experiment_data/{{session_id}}.h5", session_id=session_ids)

